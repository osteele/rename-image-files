# Technical Documentation

This document describes the technical implementation details of the rename-image-files tool.

## Architecture

The tool uses a producer-consumer pattern with threading to handle file scanning and processing:
- A scanner thread discovers image files and puts them on a queue
- The main thread processes files from the queue and handles renaming

### File Scanner

- Runs in a separate thread to prevent blocking during I/O operations
- Uses `threading.Event` for clean shutdown
- Skips dot directories (e.g., .git, .venv) during recursive scans
- Reports progress during quiet periods (1-second timeout)

### Filename Generation

The tool uses vision language models to generate descriptive filenames:
1. Extracts date from EXIF data or filename if available (YYYY-MM-DD format)
2. Sends image to model with descriptive prompt
3. Sanitizes the response for use as a filename
4. Appends original file extension (lowercase)

### Error Handling

#### Long Filenames
When a generated filename exceeds the maximum length (255 characters):
1. Retries up to 3 times with progressively stricter prompts
2. Adds "Keep it very brief" to the prompt after first attempt
3. Skips file if all attempts produce too-long names

#### Other Errors
- Permission denied: Skips directory with warning
- Target exists: Skips file with warning
- Other OS errors: Captures error message and continues

### Exit Codes

- 0: Success (all files processed successfully)
- 1: Partial success (some files were skipped)

### Progress Reporting

The tool provides three types of progress feedback:
1. Directory scanning progress (during quiet periods)
2. File processing results (immediate)
3. Final summary including:
   - Directories scanned
   - Files found
   - Files skipped (with reasons)

## File Format Details

### Filename Components

Generated filenames follow this pattern:
```
[date]-[description].[ext]
```

Where:
- `date`: Optional YYYY-MM-DD from EXIF data or original filename
- `description`: Generated by vision model, sanitized for filesystem
- `ext`: Original extension in lowercase (.jpg, .jpeg, .png, .gif)

### Filename Filtering

By default, only processes files matching these patterns:
- Start with 'IMG-' or 'IMG_' (case-insensitive)
- Look like UUIDs (e.g., 63C0900B-4465-4CF9-A310-327C627DB9EA)

Use `--all` to process all image files.

### Filename Sanitization

The sanitization process:
1. Converts to lowercase
2. Replaces spaces and punctuation with hyphens
3. Removes non-ASCII characters
4. Removes duplicate hyphens
5. Trims hyphens from start/end

## Dependencies

### Required
- Python 3.10 or later
- click: Command-line interface
- llm: Vision language model integration
- Pillow: Image and EXIF handling

### Development
- hatch: Project management
- pytest: Testing
- ruff: Linting
- black: Code formatting

## Testing

The test suite covers:
- Filename generation and sanitization
- EXIF data extraction
- Camera filename detection
- Directory traversal
- Error handling

Run tests with:
```bash
just test        # Run tests
just test-cov    # Run tests with coverage
```

## Known Limitations

1. Maximum filename length of 255 characters (filesystem limitation)
2. May require multiple attempts for verbose model outputs
3. EXIF extraction limited to common date formats
4. No support for RAW image formats
5. Directory traversal loads all entries into memory

## Future Improvements

Potential areas for enhancement:
1. Streaming directory traversal
2. Support for more image formats
3. Custom filename templates
4. Parallel file processing
5. Progress bars for large directories
6. Configurable retry strategies
7. Batch renaming preview/confirmation
